{{ define "scan" }}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Scan QR - Recycle</title>
  <style>
    body { font-family: sans-serif; margin: 16px; }
    video { width: 100%; max-width: 480px; border: 1px solid #ccc; border-radius: 6px; }
    .status { margin-top: 12px; color: #333; }
    .error { color: #b00; }
    .hint { color: #666; font-size: 12px; }
    button { padding: 10px 16px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Scanner un QR code</h1>
  <div id="unsupported" class="error" style="display:none;">
    La capture vidéo n'est pas supportée par ce navigateur. Essayez Chrome/Firefox récent ou scannez avec l'appareil photo et ouvrez le lien généré.
  </div>
  <video id="video" playsinline></video>
  <div class="status" id="status">Démarrage de la caméra...</div>
  <div class="hint">Le QR doit contenir une URL de type recycle://view/{id} ou /view/{id}</div>
  <button id="stopBtn" style="display:none;">Arrêter</button>

  <script type="module">
    import QrScanner from '/static/qr-scanner.min.js';
    (async function() {
      const video = document.getElementById('video');
      const status = document.getElementById('status');
      const stopBtn = document.getElementById('stopBtn');
      const unsupported = document.getElementById('unsupported');

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        unsupported.style.display = 'block';
        status.textContent = 'Caméra non disponible.';
        return;
      }

      let scanner;
      try {
        scanner = new QrScanner(
          video,
          result => {
            status.textContent = 'QR détecté: ' + result;
            const parsed = extractIdOrPath(result);
            if (parsed.id) {
              scanner.stop();
              window.location.href = '/view/' + parsed.id;
            } else if (parsed.locId) {
              scanner.stop();
              window.location.href = '/location?id=' + parsed.locId;
            } else if (parsed.path) {
              scanner.stop();
              const p = encodeURIComponent(parsed.path);
              window.location.href = '/location?path=' + p;
            } else {
              status.textContent = 'QR détecté mais non reconnu: ' + result;
            }
          },
          { highlightScanRegion: true }
        );
        await scanner.start();
        stopBtn.style.display = 'inline-block';
        stopBtn.onclick = () => { scanner.stop(); status.textContent = 'Scanner arrêté.'; };
        status.textContent = 'Caméra active, scannez un QR...';
      } catch (e) {
        unsupported.style.display = 'block';
        status.textContent = 'Impossible de démarrer la caméra : ' + e;
      }

      function extractIdOrPath(text) {
        let m = text.match(/^PRT-(\d+)$/i);
        if (m) return { id: m[1] };
        m = text.match(/^LOC-(\d+)$/i);
        if (m) return { locId: m[1] };
        m = text.match(/recycle:\/\/view\/(\d+)/i);
        if (m) return { id: m[1] };
        m = text.match(/https?:\/\/[^\s]+\/view\/(\d+)/i);
        if (m) return { id: m[1] };
        m = text.match(/https?:\/\/[^\s]+\/location\?id=(\d+)/i);
        if (m) return { locId: m[1] };
        m = text.match(/^\d+$/);
        if (m) return { id: m[0] };
        // localisation: webapp://loc?p=... ou /location?path=...
        m = text.match(/webapp:\/\/loc\?p=([\w\-\._~\/]+)/i);
        if (m) return { path: decodeURIComponent(m[1]) };
        m = text.match(/\/location\?path=([\w\-\._~%\/]+)/i);
        if (m) return { path: decodeURIComponent(m[1]) };
        // sinon, si c'est lisible, on le tente comme path brut
        return { path: text };
      }
    })();
  </script>
</body>
</html>
{{ end }}

